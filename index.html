<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ©Ÿè»Šé˜²ç«Šè¿½è¹¤ç³»çµ±</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
    background-color: #121212;
    color: white;
    overflow: hidden;
  }
  h1 {
    position: absolute;
    top: 15px; left: 20px;
    margin: 0;
    font-size: 22px;
    font-weight: bold;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.7);
    z-index: 1000;
  }
  #map {
    height: 100vh;
    width: 100%;
  }
  .controls {
    position: absolute;
    bottom: 20px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 12px 20px;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    z-index: 1000;
  }
  button {
    background: linear-gradient(135deg, #ff4b2b, #ff416c);
    border: none;
    padding: 10px 18px;
    border-radius: 12px;
    color: white;
    font-size: 15px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
  }
  button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(255,65,108,0.6);
  }
  button.active {
    background: linear-gradient(135deg, #00c853, #00e676);
    box-shadow: 0 4px 10px rgba(0,230,118,0.6);
  }
  #stop-locate-btn {
    background: #f44336 !important;
  }
  #last-update {
    font-size: 13px;
    color: #ccc;
  }
</style>
</head>
<body>
<h1>ğŸ æ©Ÿè»Šé˜²ç«Šè¿½è¹¤</h1>
<div id="map"></div>
<div class="controls">
  <button id="refresh-btn">ğŸ”„ æ›´æ–°æ©Ÿè»Šä½ç½®</button>
  <button id="locate-btn">ğŸ“ é–‹å§‹è¿½è¹¤æˆ‘çš„ä½ç½®</button>
  <button id="stop-locate-btn" style="display:none;">â›” åœæ­¢è¿½è¹¤</button>
  <button id="toggle-path-btn" class="active">ğŸ›£ éš±è—è»Œè·¡ç·š</button>
  <p>æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="last-update">ç„¡è³‡æ–™</span></p>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const firebaseUrl = 'https://moto-anti-theft-default-rtdb.asia-southeast1.firebasedatabase.app/alerts.json';

  const map = L.map('map').setView([25.0476, 121.5174], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  const bikeIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40],
  });

  let bikeMarker = L.marker([25.0476, 121.5174], {icon: bikeIcon}).addTo(map).bindPopup('<b>æ‚¨çš„æ©Ÿè»Š</b>');

  let bikePath = [];
  let polyline = L.polyline([], {color: '#ff416c', weight: 4}).addTo(map);
  let pathVisible = true;

  let userMarker = null;
  let watchId = null;

  // å–å¾—æœ€æ–°æ©Ÿè»Šä½ç½®
  async function updateBikeLocation() {
    try {
      const res = await fetch(firebaseUrl);
      const data = await res.json();
      if (!data) return;

      const records = Object.values(data);
      bikePath = records.filter(r => r.lat && r.lon).map(r => [r.lat, r.lon]);

      if (bikePath.length > 0) {
        const latest = bikePath[bikePath.length - 1];
        bikeMarker.setLatLng(latest);
        map.setView(latest);

        if (pathVisible) {
          polyline.setLatLngs(bikePath);
        }

        const lastRecord = records[records.length - 1];
        document.getElementById('last-update').textContent = lastRecord.timestamp || new Date().toLocaleString();
      }
    } catch (e) {
      console.error('å–å¾— Firebase è³‡æ–™éŒ¯èª¤:', e);
    }
  }

  // é–‹å§‹è¿½è¹¤ä½¿ç”¨è€…ä½ç½®
  document.getElementById('locate-btn').addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½');
      return;
    }
    if (watchId !== null) return;

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if (userMarker) {
          userMarker.setLatLng([lat, lng]);
        } else {
          const userIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30],
          });
          userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map).bindPopup('<b>æ‚¨çš„ä½ç½®</b>').openPopup();
        }

        // èª¿æ•´è¦–é‡åŒ…å«ä½¿ç”¨è€…å’Œæ©Ÿè»Š
        const bounds = L.latLngBounds([lat, lng], bikeMarker.getLatLng());
        map.fitBounds(bounds, {padding: [50, 50]});
      },
      (err) => {
        alert('ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®: ' + err.message);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0,
      }
    );

    // UI åˆ‡æ›
    document.getElementById('locate-btn').style.display = 'none';
    document.getElementById('stop-locate-btn').style.display = 'inline-block';
  });

  // åœæ­¢è¿½è¹¤ä½¿ç”¨è€…ä½ç½®
  document.getElementById('stop-locate-btn').addEventListener('click', () => {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if (userMarker) {
      map.removeLayer(userMarker);
      userMarker = null;
    }

    // UI åˆ‡æ›
    document.getElementById('stop-locate-btn').style.display = 'none';
    document.getElementById('locate-btn').style.display = 'inline-block';
  });

  // åˆ‡æ›è»Œè·¡ç·šé¡¯ç¤º
  document.getElementById('toggle-path-btn').addEventListener('click', function () {
    pathVisible = !pathVisible;
    if (pathVisible) {
      polyline.setLatLngs(bikePath);
      this.textContent = 'ğŸ›£ éš±è—è»Œè·¡ç·š';
      this.classList.add('active');
    } else {
      polyline.setLatLngs([]);
      this.textContent = 'ğŸ›£ é¡¯ç¤ºè»Œè·¡ç·š';
      this.classList.remove('active');
    }
  });

  // è‡ªå‹•æ›´æ–°æ©Ÿè»Šä½ç½®
  setInterval(updateBikeLocation, 30000);
  updateBikeLocation();
</script>
</body>
</html>
